# ICPEx Liquidity Adapator

## 1. Create public pool liquidity
### 1.1 Description
-  First, call the approve method of ICP ledger(PID:ryjl3-tyaaa-aaaaa-aaaba-cai). The spender parameter is set to ICPEx router canister PID(2ackz-dyaaa-aaaam-ab5eq-cai), the amount is the number of ICP tokens corresponding to 1 USD. To reduce the impact of price fluctuations on deductions, it is recommended to multiply the ICP amount by about 1.1
- Approve the required token amount for liquidity addition to the router(PID:2ackz-dyaaa-aaaam-ab5eq-cai). If the token pair includes ICP, the approved amount should include the equivalent of 1 USD * 1.1 in ICP. If the ICRC-1 standard is used, the amount of liquidity to be added needs to be transferred to the sub-account under the router(PID:2ackz-dyaaa-aaaam-ab5eq-cai). The sub-account is generated by the caller's PID.
- Call the ICPEx Router Canister(PID:2ackz-dyaaa-aaaam-ab5eq-cai) createCommonPool method, The payment will be deducted after the pool canister is created successfully.
## 1.2 Endpoint - createCommonPool
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
  createCommonPool : (
      principal,
      principal,
      nat,
      nat,
      nat,
      nat,
      nat,
      nat64,
      opt bool,
    ) -> (Result);
  type Result = variant { Ok : record { principal; nat }; Err : text };
```

* Request parameters:
  
| Order | Name              | 	Description                                                                                                                                                                                                          |
|-------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | base_token | 	The base token PID  |
| 2     | quote_token | 	The quote token PID  |
| 3     | base_in_amount | 	The amount of base token required to add liquidity    |
| 4     | quote_in_amount | 	The amount of quote token required to add liquidity   |
| 5     | fee_rate | The collected fee rate has a precision of 18 decimal  |
| 6     | i | For a standard pool, set i to 1_000_000_000_000_000_000. For a single pool, i should be the price with 18 decimal places of precision.  |
| 7     | k | Volatility Coefficient,The smaller the volatility coefficient, the smaller the volatility of the trading market and the deeper the market depth. With the precision of 18 decimal places, if k=1, the value to be passed in is 1_000_000_000_000_000_000. "  |
| 8     | deadline | Create pool deadline. Unit: nanoseconds.  |
| 9     | relinquish_on | If true, the control of the pool will be transferred to a black hole account (aaaaa-aa). Once confirmed, this change is irreversible. |


## 2. Add public pool liquidity
### 2.1 Description
1. First, acquire the canisterId of the Pool. 
2. Get the input amount required to add liquidity by calling the queryAddShareBase/queryAddShareQuote method on the router canister.
3. If the ICRC-1 standard is used, the amount of liquidity to be added needs to be transferred to the sub-account under the router(PID:2ackz-dyaaa-aaaam-ab5eq-cai). The sub-account is generated by the caller's PID.
4. Call the addLiquidity method on the router canister.
## 2.2 Endpoint - queryAddShareBase/queryAddShareQuote
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
  //input base amount
  queryAddShareBase : (nat, principal) -> (nat, nat, nat, nat) query;
  //input quote amount
  queryAddShareQuote : (nat, principal) -> (nat, nat, nat, nat) query;
```

* Request parameters:

| Order | Name              | 	Description                                                                                                                                                                                                          |
|-------|-------------------|-----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| 1     | base/quote_amount | 	the input base/quote amount                                                                                                                                                                                                     |
| 2     | pool_id           | 	pool canister id                                                                                                                                                                                            |


* Response parameters:

| Order | Name         | 	Description                                         |
|-------|--------------|------------------------------------------------------|
  | 1     | base_input   | 	The amount of base token required to add liquidity  |
  | 2     | quote_input  | 		The amount of base token required to add liquidity |
| 3     | shares       | 		The amount of LP used for adding liquidity.        |
| 4     | total_shares | 		Total LP amount after adding liquidity             |



## 2.3 Endpoint - addLiquidity
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
    addLiquidity : (principal, nat, nat, nat, nat64) -> (nat, nat, nat);
```

* Request parameters:

| Order | Name            | 	Description                                                                                                                    |
|-------|-----------------|---------------------------------------------------------------------------------------------------------------------------------|
| 1     | pool_addr       | 	The canisterId of the pool to which liquidity is to be added                                                                   |
| 2     | base_in_amount  | 	The amount of base token required to add liquidity                                                                             |
| 3     | quote_in_amount | 	The amount of quote token required to add liquidity                                                                            |
| 4     | slippage | 	Trading slippage, with 18-digit precision. If the slippage exceeds the limit when adding liquidity, the transaction will fail. |
| 5     | deadline | 	Add liquidity deadline. Unit: nanoseconds                                                                                      |

* Response parameters:

| Order | Name            | 	Description                                                  |
|-------|-----------------|---------------------------------------------------------------|
| 1     | shares| 	The actual amount of LP used for adding liquidity.    |
| 2     | base_adjusted_in_amount  | 	The actual amount of base token required to add liquidity    |
| 3     | quote_adjusted_in_amount | 	The actual amount of quote token required to add liquidity   |



## 3. Removing LP
### 3.1 Description
Removing liquidity endpoint.
### 3.2 Endpoint - querySellShares
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
  querySellShares : (nat, principal, principal) -> (nat, nat, nat, nat) query;
```
* Request parameters:

  
| Order | Name            | 	Description                                                                                                                    |
|-------|-----------------|---------------------------------------------------------------------------------------------------------------------------------|
| 1     | share_rate       | 	Proportion to be removed.  |
| 2     | owner  | 	The PID of the user holding the LP.                                                                             |
| 3     | pool_addr  | 	The canister ID of the pool where the LP needs to be removed.        |


* Response parameters:

| Order | Name            | 	Description                                                  |
|-------|-----------------|---------------------------------------------------------------|
| 1     | base_amount| 	The amount of base token to be removed.    |
| 2     | quote_amount  | 	The amount of quote token to be removed.   |
| 3     | lp_amount | 	The amount of LP to be removed.   |
| 4     | total_lp_amount | 	The actual amount of the total LP.   |

### 3.3 Endpoint - sellShares
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
    sellShares : (nat, principal, nat, nat, nat, nat64) -> (nat, nat);
```
* Request parameters:

  
| Order | Name            | 	Description                                                                                                                    |
|-------|-----------------|---------------------------------------------------------------------------------------------------------------------------------|
| 1     | share_amount       | 	The amount of LP to be removed.   |
| 2     | pool_addr  | 		The canister ID of the pool where the LP needs to be removed.                                                                              |
| 3     | base_amount  | 	The amount of baseToken  want to receive.        |
| 4     | quote_amount  | 	The amount of quoteToken want to receive.       |
| 5     | slippage  | 	Slippage, 18 decimal        |
| 6     | deadline  | 	Unit: nanosecond.      |


* Response parameters:

| Order | Name            | 	Description                                                  |
|-------|-----------------|---------------------------------------------------------------|
| 1     | receive_base_amount| 	Base amount received    |
| 2     | receive_quote_amount  | 	Quote amount received   |

## 4. Transfer LP
### 4.1 Description
Use this endpoint to transfer own LP to another user's.
### 4.2 Endpoint
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
      type Result_2 = variant { Ok; Err : text };
      transferLiquidity : (principal, principal, nat) -> (Result_2);
      transferLiquidityV2: (principal, principal, nat) → (variant {Ok:nat; Err:text}) 
```
* Request parameters:

  
| Order | Name            | 	Description                                                                                                                    |
|-------|-----------------|---------------------------------------------------------------------------------------------------------------------------------|
| 1     | pool_addr       | 	The canister ID of the pool where the LP needs to be transferred.  |
| 2     | to  | 	The PID of the user receiving the LP.                                                                             |
| 3     | transfer_percent  | 	The ratio of LP being transferred, with a precision of 18. For example, the number for 50% would be 500000000000000000.        |

* Response parameters:</br>
If using `transferLiquidityV2`, it will return transferred LP shares in Ok.

## 5. Lock LP
### 5.1 Description
Use this endpoint to lock own LP. LP will be transferred to the blackhole address(aaaaa-aa)
### 5.2 Endpoint
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
      type Result_2 = variant { Ok; Err : text };
      lockLiquidity : (principal, nat, nat64) -> (Result_2);
      lockLiquidityV2: (principal, nat, nat64) → (variant {Ok:nat; Err:text}) 
```
* Request parameters:

| Order | Name            | 	Description                                                                                                                    |
|-------|-----------------|---------------------------------------------------------------------------------------------------------------------------------|
| 1     | pool_addr       | 	The canister ID of the pool where the LP needs to be locked.  |
| 2     | lock_percent  | 	The ratio of LP being locked, with a precision of 18. For example, the number for 50% would be 500000000000000000.        |
| 3     | expire_time  | 	Currently only supports 0, which means permanent lock.                                                                           |

* Response parameters:</br>
If using `lockLiquidityV2`, it will return locked LP shares in Ok.

## 6. Query LP
### 6.1 Description
Query the amount of LP shares the user holds in the respective pool.
### 6.2 Endpoint
* Canister PID: 2ackz-dyaaa-aaaam-ab5eq-cai
* Candid:
```candid
  getPoolInfo : (principal, principal) -> (PoolInfo) query;
  type PoolInfo = record {
    i : nat;
    k : nat;
    base_reserve : nat;
    owner : principal;
    block_timestamp_last : nat64;
    pool_addr : principal;
    lp_amount : nat;
    pool_type : text;
    lp_lock : nat;
    quote_user : nat;
    lp_fee_rate : nat;
    base_token_decimals : nat8;
    quote_token_decimals : nat8;
    base_user : nat;
    quote_token : principal;
    base_price_cumulative_last : nat;
    quote_reserve : nat;
    base_token : principal;
    pool_status : PoolStatus;
    mt_fee_rate : nat;
    is_single_pool : bool;
    total_supply : nat;
    is_my_pool : bool;
  };
```
* Request parameters:


| Order | Name            | 	Description                                                                                                                    |
|-------|-----------------|---------------------------------------------------------------------------------------------------------------------------------|
| 1     | pool_addr       | 	The canister ID of the pool where the LP needs to be locked.  |
| 2     | query_user  | 	The principal of the query user      |


* Response parameters:

| Order | Name                         | Description                                                                 |
|-------|------------------------------|-----------------------------------------------------------------------------|
| 1     | i                            | i is the initial guide price.                                           |
| 2     | k                            | k is the volatility coefficient.|
| 3     | base_reserve                  | The amount of base tokens in the pool.                                 |
| 4     | owner                         | The principal of the pool's creator.                             |
| 5     | block_timestamp_last          | The timestamp of the last block when an action occurred in the pool.         |
| 6     | pool_addr                     | The principal of the pool's address.                           |
| 7     | lp_amount                     | The amount of LP shares the user holds in the pool.                          |
| 8     | pool_type                     | The type of pool (e.g., LPC,LPS,LPP).                         |
| 9     | lp_lock                       | The amount of LP shares that are locked.                                    |
| 10    | quote_user                    | The amount of quote tokens the user has in the pool.                        |
| 11    | lp_fee_rate                   | The liquidity provider fee rate for the pool.                               |
| 12    | base_token_decimals           | The number of decimals for the base token.                                  |
| 13    | quote_token_decimals          | The number of decimals for the quote token.                                 |
| 14    | base_user                     | The amount of base tokens the user has in the pool.                         |
| 15    | quote_token                   | The principal of the quote token.                              |
| 16    | base_price_cumulative_last    | The last price of the base token.                                |
| 17    | quote_reserve                 | The amount of quote tokens in the pool.                                |
| 18    | base_token                    | The principal of the base token.                               |
| 19    | pool_status                   | The current status of the pool.                      |
| 20    | mt_fee_rate                   | The DEX fee rate for the pool.                                   |
| 21    | is_single_pool                | Boolean indicating whether this is a single-token pool.                     |
| 22    | total_supply                  | The total supply of LP shares for the pool.                                 |
| 23    | is_my_pool                    | Boolean indicating whether this pool was created by the user.                   |
